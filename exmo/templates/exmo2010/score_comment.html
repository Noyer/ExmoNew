{% comment %}
# This file is part of EXMO2010 software.
# Copyright 2010, 2011 Al Nikolov
# Copyright 2010, 2011, 2012 Institute for Information Freedom Development
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU Affero General Public License as
#    published by the Free Software Foundation, either version 3 of the
#    License, or (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU Affero General Public License for more details.
#
#    You should have received a copy of the GNU Affero General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
{% endcomment %}
{% load i18n comments check_object_permission days_until %}
{% check_object_permission exmo2010.comment_score object as can_comment %}
{% check_object_permission exmo2010.view_comment_score object as can_view_comment %}

{% if can_view_comment %}

    {% get_comment_list for object as comment_list %}
    {% if comment_list %}
        <table class="table-comments-parameter">
            <tbody>
            {% for comment in comment_list %}
                <tr id="c{{ comment.id }}">
                    <td
                    {% with comment.submit_date|days_until:object.parameter.monitoring.time_to_answer as days_remaining %}
                    {% if request.user.profile.is_internal and comment.user.profile.is_organization and comment.status == 0 %}
                        {% if days_remaining < 0 %}class="answer-missed"{% endif %}
                        {% if days_remaining == 0 %}class="answer-today"{% endif %}
                        {% if days_remaining > 0 %}class="answer-later"{% endif %}
                    {% endif %}
                    {% if request.user.profile.is_expertA %}
                        {% if days_remaining < 0 %}data-class="answer-missed"{% endif %}
                        {% if days_remaining == 0 %}data-class="answer-today"{% endif %}
                        {% if days_remaining > 0 %}data-class="answer-later"{% endif %}
                    {% endif %}
                    {% endwith %}
                    >
                        <span class="author">
                        {% if comment.user.userprofile.is_expert %}
                            {% if request.user.userprofile.is_expert %}
                                {{ comment.user_name }}
                            {% else %}
                                {% trans 'Foundation Analyst' %}
                            {% endif %}
                        {% else %}
                            {% if not comment.user.first_name or not comment.user.last_name %}
                                {{ comment.user.first_name }} {{ comment.user.last_name }}
                            {% else %}
                                {{ comment.user.email }}
                            {% endif %}
                        {% endif %}
                        </span>

                        <span class="comment-date">
                        {{ comment.submit_date|date:"H:i d.m.Y" }}
                        </span>

                        <div class="comment-content">
                            {{ comment.comment|safe }}
                        </div>

                        {% if request.user.userprofile.is_expertA and comment.user.userprofile.is_organization %}
                        <div class="toggle-comment-container">
                            {% url exmo2010:toggle_comment as toggle_url %}
                            <a class="toggle-comment"
                               style="border-bottom: 1px dashed;"
                               href="{{ toggle_url }}"
                               rel="{{ comment.pk }}">
                                {% if comment.status == 0 %}
                                    {% trans 'Close without answer' %}
                                {% else %}
                                    {% trans 'Open comment' %}
                                {% endif %}
                            </a>
                        </div>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    {% endif %}
{% endif %}

{% load wysiwyg %}
{% wysiwyg_setup %}

{% if can_comment %}

    {% if peremptory_day %}
        <div class="notification-peremptory">
            {% trans 'Peremptory day to answer your question is' %}
            {{ peremptory_day|date:"j F Y" }}
        </div>
    {% endif %}

    <h3 class="heading-yourcomment-parameter">{% trans 'Your comment' %}</h3>

    {% get_comment_form for object as form %}
    <form action="{% comment_form_target %}" method="post">{% csrf_token %}
        {% for hidden in form.hidden_fields %}
            {{ hidden }}
        {% endfor %}
        {% if user %}
            <input type="hidden" name="id_user" value="{{ user }}" />
        {% else %}
            <label class="label-comment">{{ form.user.label }}</label>
            <br />
            {{ form.user }}
            <br />
        {% endif %}
        {% if user.email %}
            <input type="hidden" name="id_email" value="{{ user.email }}" />
        {% else %}
            <label class="label-comment">{{ form.email.label }}</label>
            <br />
            {{ form.email }}
        {% endif %}
        {{ form.comment }}
        {% wysiwyg_editor "id_comment" %}
        <input type="hidden" name="next" value="{% url exmo2010:score_view object.pk %}" />
        <input type="submit" name="post" id="submit-comment" class="submit-post" value="{% trans 'Post' %}">
    </form>
{% endif %}

